---
title: "Write Up : MCG/Future：面向高版本JDK的探讨 - 编程开发 -  MCBBS纪念版 -  Minecraft(我的世界)中文论坛"
source: "https://www.mcbbs.co/thread-2334-1-1.html"
author:
  - "[[MCBBS Memorial Edition Team]]"
published:
created: 2025-02-07
description: "[/td][/tr][/table][table=98%][tr=#420603][td][table=98%,White][tr][td]【警告】MCG是一个EOL项目，而本系列文章的公开无疑会再次降低MCG的安全性。无论如何，请不要 ... Write Up : MCG/Future：面向高版本JDK的探讨 ,MCBBS纪念版"
tags:
  - "clippings"
---
<table><tbody><tr><td rowspan="2"><div><div><p><a href="https://www.mcbbs.co/space-uid-7969.html">huzpsb</a></p></div><div><div><div><p><strong><a href="https://www.mcbbs.co/space-uid-7969.html">huzpsb</a></strong> <em>当前离线</em></p></div><div><table><tbody><tr><th><p><a href="https://www.mcbbs.co/home.php?mod=space&amp;uid=7969&amp;do=thread&amp;type=thread&amp;view=me&amp;from=space">8</a></p>主题</th><th><p><a href="https://www.mcbbs.co/home.php?mod=space&amp;uid=7969&amp;do=thread&amp;type=reply&amp;view=me&amp;from=space">33</a></p>回帖</th><td><p><a href="https://www.mcbbs.co/home.php?mod=space&amp;uid=7969&amp;do=profile">241</a></p>积分</td></tr></tbody></table></div><dl><dt>积分</dt><dd><a href="https://www.mcbbs.co/home.php?mod=space&amp;uid=7969&amp;do=profile">241</a></dd><dt></dt><dd></dd><dt></dt><dd></dd><dt>UID</dt><dd><a href="https://www.mcbbs.co/?7969">7969</a></dd></dl><p><a href="http://"><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/forumlink.gif"></a> <a href="https://www.mcbbs.co/home.php?mod=space&amp;uid=7969&amp;do=profile"><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/userinfo.gif"></a></p></div></div><div><p><a href="https://www.mcbbs.co/space-uid-7969.html"><img src="https://www.mcbbs.co/uc_server/avatar.php?uid=7969&amp;size=middle&amp;ts=1"></a></p></div><p><em><a href="https://www.mcbbs.co/home.php?mod=spacecp&amp;ac=usergroup&amp;gid=42"><span>男同大王</span></a></em></p><dl><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/dyy.png">人气</dt><dd>15 点</dd><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/jinli.png">金粒</dt><dd>463 粒</dd><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/lvbaoshi.png">宝石</dt><dd>0 颗</dd><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/apple.png">爱心</dt><dd>1 颗</dd><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/zuanshi.png">钻石</dt><dd>81 颗</dd><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/yingwuluoke.png">贡献</dt><dd>0 点</dd></dl><nav></nav><ul><li><a href="https://www.mcbbs.co/home.php?mod=spacecp&amp;ac=pm&amp;op=showmsg&amp;handlekey=showmsg_7969&amp;touid=7969&amp;pmid=0&amp;daterange=2&amp;pid=62819&amp;tid=2334">发消息</a></li></ul></div></td><td><div><p><label>电梯直达</label> <span><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/fj_btn.png"></span></p><p><strong><a href="https://www.mcbbs.co/thread-2334-1-1.html">楼主</a></strong></p><div><p><img src="https://www.mcbbs.co/static/image/common/%E7%94%A8%E6%88%B7%E5%9B%9E%E5%B8%96%E5%9B%BE%E6%A0%87.png"> <span>|</span> <a href="https://www.mcbbs.co/forum.php?mod=viewthread&amp;tid=2334&amp;page=1&amp;authorid=7969">只看该作者</a> <span><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/arw_r.gif"></span> <span>|</span><a href="https://www.mcbbs.co/forum.php?mod=viewthread&amp;tid=2334&amp;extra=&amp;ordertype=1">倒序浏览</a> <span>|</span>阅读模式</p></div></div><div><div><div><div><div><h3><strong>马上注册，结交更多好友，享用更多功能，让你轻松玩转社区。</strong></h3><p>您需要 <a href="https://www.mcbbs.co/member.php?mod=logging&amp;action=login">登录</a> 才可以下载或查看，没有账号？<a href="https://www.mcbbs.co/member.php?mod=register">立即注册</a> <a href="https://www.mcbbs.co/connect.php?mod=login&amp;op=init&amp;referer=forum.php%3Fmod%3Dviewthread%26tid%3D2334%26extra%3Dpage%5C%253D1%26page%3D1%26&amp;statfrom=login"><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/qq_login.gif"></a>  <a href="https://www.mcbbs.co/zxsq_bilibili-connect.html"><img src="https://www.mcbbs.co/source/plugin/zxsq_bilibili/static/images/bilibili-24.png"></a></p></div><p><span>x</span></p></div><i>本帖最后由 huzpsb 于 2025-2-5 15:51 编辑</i><div><p><span><span><span><strong>Write Up : MCG/Future：面向高版本JDK的探讨</strong></span></span></span></p><p><span><span>MCG/Future的可能实现</span></span></p></div><div><div><p><span><span><strong>【警告】</strong></span></span></p><p><span><span><span>MCG是一个EOL项目，而本系列文章的公开无疑会再次降低MCG的安全性。<strong>无论如何，请不要再使用MCG</strong>。</span></span></span></p><p><span><span><span>本系列文章旨在分享MCG的<strong>思路</strong>而不是<strong>源码</strong>；请不要尝试通过简单的复制粘贴来完成对MCG的重建。</span></span></span></p><p><span><span><span>本文涉及到UB(</span></span><span><span>Undefined behavior</span></span><span><span>)</span></span></span><span><span><span>，和大量JVM无文档API，请持审慎态度看待本篇文章！</span></span></span></p><p><span><span><span><strike>恭喜你来到了JVM的深暗之域</strike></span></span></span></p><br><hr><br><span><span><strong><span>▌Part 1 JEP260<br></span></strong></span></span><span><strong>1.1 内容</strong></span><br>Encapsulate Most Internal APIs的大义是利用JEP200与JEP261来控制对Field的访问。考虑以下代码：<br><div><div><ol><li>Method m = System.class.getDeclaredMethod("setJavaLangAccess");<br></li><li>m.setAccessible(true);</li></ol></div><p><em>复制代码</em></p></div>这段代码在Java8中是完全正确的。但是在Java21中，它会产生以下报错：<br><div><div><ol><li>Exception in thread "main" java.lang.reflect.InaccessibleObjectException: Unable to make private static void java.lang.System.setJavaLangAccess() accessible: module java.base does not "opens java.lang" to unnamed module @4e50df2e<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;at java.base/java.lang.reflect.AccessibleObject.throwInaccessibleObjectException(AccessibleObject.java:391)<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:367)<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:315)<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;at java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:203)<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;at java.base/java.lang.reflect.Method.setAccessible(Method.java:197)</li></ol></div><p><em>复制代码</em></p></div>这是因为，java.lang并不对当前模块开放。当然，受到推荐的做法有：<br>- 不使用JVM的内部API<br>- 在启动参数中添加--add-opens java.base/java.lang=ALL-UNNAMED<br>但是，前者无疑会使得本文失去探讨的意义；后者会增加用户的工作量。事实上，它会劝退很多用户！<span><strong>1.2 解决</strong></span><br>那么，有没有解决方案呢？首先让我们检查setAccessible<div><div><ol><li>&lt;blockquote&gt;@Override</li></ol></div><p><em>复制代码</em></p></div>一个自然的思路就是，把setAccessible0拿到手。这可行吗？<br>让我们试一试。<br><div><div><ol><li>Method m = AccessibleObject.class.getDeclaredMethod("setAccessible0", boolean.class);<br></li><li>m.setAccessible(true);</li></ol></div><p><em>复制代码</em></p></div>结果是<br><div><div><ol><li>Exception in thread "main" java.lang.reflect.InaccessibleObjectException: Unable to make boolean java.lang.reflect.AccessibleObject.setAccessible0(boolean) accessible: module java.base does not "opens java.lang.reflect" to unnamed module @4e50df2e</li></ol></div><p><em>复制代码</em></p></div>这说明这个思路不可行——setAccessible0需要被setAccessible，这是循环依赖。就要在这里结束了吗？<br>让我们仔细阅读JEP260：<br><div><blockquote>Critical internal APIs not encapsulated in JDK 9<br>The critical internal APIs that are not encapsulated in JDK 9, because supported replacements did not exist in JDK 8, are listed here.<br>省略号<br>sun.reflect.ReflectionFactory<br>省略号</blockquote></div><br>这个sun.reflect.ReflectionFactory是什么东西？让我们看看？<br><div><blockquote>ReflectionFactory supports custom serialization.<br>Its methods support the creation of uninitialized objects, invoking serialization<br>private methods for readObject, writeObject, readResolve, and writeReplace.</blockquote></div><br><strike>什么又臭又长的，我只看得到private methods</strike><br>快端上来吧！<br><div><div><ol><li>Constructor&lt;?&gt; ctor = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(MethodHandles.Lookup.class, MethodHandles.Lookup.class.getDeclaredConstructor(Class.class));<br></li><li>Class&lt;AccessibleObject&gt; aoc = AccessibleObject.class;<br></li><li>MethodHandles.Lookup lookup = (MethodHandles.Lookup) ctor.newInstance(aoc);<br></li><li>MethodHandle export = lookup.findVirtual(aoc, "setAccessible0", MethodType.methodType(Boolean.TYPE, Boolean.TYPE));<br></li><li>export.invoke(ao, true);</li></ol></div><p><em>复制代码</em></p></div>其中ao是需要操作的AccessibleObject。至此，我们已经可以任意开放AccessibleObject的权限了。<hr><br><span><span><strong><span>▌Part 2 JEP486<br></span></strong></span></span><strong><span>2.1 内容</span><br></strong>Permanently Disable the Security Manager的大义是肘击SecurityManager使其不可用。考虑以下代码：<br><div><div><ol><li>System.setSecurityManager(new SecurityManager());<br></li><li></li></ol></div><p><em>复制代码</em></p></div>这段代码在Java8中是完全正确的。但是在Java21中，它会产生以下报错：<br><div><div><ol><li>Exception in thread "main" java.lang.UnsupportedOperationException: The Security Manager is deprecated and will be removed in a future release<br></li><li></li></ol></div><p><em>复制代码</em></p></div>让我们跟踪一下原因。JEP486引入了以下代码：<div><div><ol><li>// return true if a security manager is allowed</li></ol></div><p><em>复制代码</em></p></div>这是很坏的。<br><strong><span><br>2.2 解决？</span></strong><br>我们在《Write Up : MCG/DynaGuard：JVM层HIPS的原理与实现》已经提到过关于getDeclaredFields0的获取与使用；在这里不再赘述。<br>现在我们能够获取并正确访问到allowSecurityManager字段了。我们只需要<br><div><div><ol><li>allowSecurityManagerField.set(null, 2);</li></ol></div><p><em>复制代码</em></p></div>对吧？<br>对吗？！<br>报错怎么还在？没关系，让我们打一个断点，看看为什么值未设置成功。<br>问题开始浮出水面——当你在allowSecurityManager方法处下断点的一瞬间，这个报错就不会再出现了。<p><strong><span>2.3 解决</span></strong><br>合理怀疑，是JVMTI的存在使得对应的方法脱离了JIT状态。</p><strike>因此我们只需要使用-client或者redefine一下System使其脱离JIT状态即可</strike><br>但是为什么JIT会带来脏数据呢？allowSecurityManager甚至不是final字段。让我们仔细检查一下allowSecurityManager字段的定义：<br><div><div><ol><li>private static @Stable int allowSecurityManager;</li></ol></div><p><em>复制代码</em></p></div>Stable是什么意思？让我们看看javadoc：<br><div><blockquote>The HotSpot VM relies on this annotation to promote a non-null (resp.,<br>non-zero) component value to a constant, thereby enabling superior<br>optimizations of code depending on such a value (such as constant folding).<br>More specifically, the HotSpot VM will process non-null stable fields (final<br>or otherwise) in a similar manner to static final fields with respect to<br>promoting the field's value to a constant.&nbsp;&nbsp;Thus, placing aside the<br>differences for null/non-null values and arrays, a final stable field is<br>treated as if it is really final from both the Java language and the HotSpot<br>VM.<br>It is (currently) undefined what happens if a field annotated as stable<br>is given a third value (by explicitly updating a stable field, a component of<br>a stable array, or a final stable field via reflection or other means).<br>Since the HotSpot VM promotes a non-null component value to constant, it may<br>be that the Java memory model would appear to be broken, if such a constant<br>(the second value of the field) is used as the value of the field even after<br>the field value has changed (to a third value).</blockquote></div><br>好好好，简单来说，Stable的意思是比final更强的inline。修改Stable字段的值是UB。<br>那么我们需要一种方法来刷新脏数据。JIT的问题应该让JIT解决——比如说触发JIT/C2怎么样？只需要调用10w次就可以了。<br><div><div><ol><li>int jit = 100005;<br></li><li>SecurityManager sm = new SecurityManager();<br></li><li>while (true) {<br></li><li>&nbsp; &nbsp; jit -= 1;<br></li><li>&nbsp; &nbsp; if (jit &lt;= 0) {<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;throw new RuntimeException("JIT failed?!");<br></li><li>&nbsp; &nbsp; }<br></li><li>&nbsp; &nbsp; try {<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;System.setSecurityManager(sm);<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;break;<br></li><li>&nbsp; &nbsp; } catch (Throwable t) {<br></li><li>&nbsp; &nbsp; }<br></li><li>}</li></ol></div><p><em>复制代码</em></p></div>搞定！<br>此外我还想不加解释地附上关闭警告的代码。<br><div><div><ol><li>Class&lt;?&gt; clz = Class.forName("java.lang.System$CallersHolder");<br></li><li>Field callersField = clz.getDeclaredField("callers");<br></li><li>makeAccessible(callersField); // 第一章提到的方法<br></li><li>Map map = (Map) callersField.get(null);<br></li><li>map.put(你的clz, true);</li></ol></div><p><em>复制代码</em></p></div><hr><br>不过目前看来我确实是没动力将这部分内容实装进MCG了<br>就这样吧？<br>以上，hs<p><strong><span><span>——END——</span></span></strong></p></div><br></div></div><div><p><a href="https://www.mcbbs.co/forum.php?mod=misc&amp;action=viewthreadmod&amp;tid=2334">本主题由 管理团队 于 <span>前天&nbsp;15:55</span> 审核通过</a></p></div></div><h3><span></span>评分</h3><dl><dd><table><tbody><tr><th><a href="https://www.mcbbs.co/forum.php?mod=misc&amp;action=viewratings&amp;tid=2334&amp;pid=62819">参与人数 <span>1</span></a></th><th>人气 <i><span>+3</span></i></th><th>收起 <i>理由</i></th></tr></tbody><tbody><tr><td><a href="https://www.mcbbs.co/space-uid-3187.html"><img src="https://www.mcbbs.co/uc_server/avatar.php?uid=3187&amp;size=small&amp;ts=1"></a> <a href="https://www.mcbbs.co/space-uid-3187.html">洞穴夜莺</a></td><td>+ 3</td><td>不过，为什么要设置SecurityManager？ ...</td></tr></tbody></table><p><a href="https://www.mcbbs.co/forum.php?mod=misc&amp;action=viewratings&amp;tid=2334&amp;pid=62819">查看全部评分</a></p></dd></dl></div></td></tr><tr><td><div><div><p><b>分享到:&nbsp;</b> <a href="https://www.mcbbs.co/#"><i><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/qzone.gif">QQ空间</i></a></p></div><p><a href="https://www.mcbbs.co/home.php?mod=spacecp&amp;ac=favorite&amp;type=thread&amp;id=2334&amp;formhash=06e9ae22"><i><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/like.png">收藏<span>0</span></i></a></p></div><div><p><b>帖子永久地址：</b>&nbsp;</p><br>&nbsp; &nbsp; &nbsp; &nbsp;<fieldset><legend>MCBBS纪念版 - 论坛版权</legend>1、本主题所有言论和图片纯属会员个人意见，与本论坛立场无关<br>2、本站所有主题由该帖子作者发表，该帖子作者与<a href="https://www.mcbbs.co/"><span>MCBBS纪念版</span></a>享有帖子相关版权<br>3、其他单位或个人使用、转载或引用本文时必须同时征得该帖子作者和<a href="https://www.mcbbs.co/"><span>MCBBS纪念版</span></a>的同意<br>4、帖子作者须承担一切因本文发表而直接或间接导致的民事或刑事法律责任<br>5、本帖部分内容转载自其它媒体，但并不代表本站赞同其观点和对其真实性负责<br>6、如本帖侵犯到任何版权问题，请立即告知本站，本站将及时予与删除并致以最深的歉意<br>7、<a href="https://www.mcbbs.co/"><span>MCBBS纪念版</span></a>管理员和版主有权不事先通知发贴者而删除本文</fieldset><br></div></td></tr><tr></tr><tr><td></td><td><div><p><em><a href="https://www.mcbbs.co/forum.php?mod=post&amp;action=reply&amp;fid=49&amp;tid=2334&amp;reppost=62819&amp;extra=&amp;page=1">回复</a></em></p><p>使用道具 举报</p></div></td></tr><tr><td></td><td></td></tr></tbody></table>