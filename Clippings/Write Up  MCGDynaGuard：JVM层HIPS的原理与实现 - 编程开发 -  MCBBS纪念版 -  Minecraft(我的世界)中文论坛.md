---
title: "Write Up : MCG/DynaGuard：JVM层HIPS的原理与实现 - 编程开发 -  MCBBS纪念版 -  Minecraft(我的世界)中文论坛"
source: "https://www.mcbbs.co/thread-2320-1-1.html"
author:
  - "[[MCBBS Memorial Edition Team]]"
published:
created: 2025-02-07
description: "[/td][/tr][/table][/td][/tr][/table] Write Up : MCG/DynaGuard：JVM层HIPS的原理与实现 ,MCBBS纪念版"
tags:
  - "clippings"
---
<table><tbody><tr><td rowspan="2"><div><div><p><a href="https://www.mcbbs.co/space-uid-7969.html">huzpsb</a></p></div><div><div><div><p><strong><a href="https://www.mcbbs.co/space-uid-7969.html">huzpsb</a></strong> <em>当前离线</em></p></div><div><table><tbody><tr><th><p><a href="https://www.mcbbs.co/home.php?mod=space&amp;uid=7969&amp;do=thread&amp;type=thread&amp;view=me&amp;from=space">8</a></p>主题</th><th><p><a href="https://www.mcbbs.co/home.php?mod=space&amp;uid=7969&amp;do=thread&amp;type=reply&amp;view=me&amp;from=space">33</a></p>回帖</th><td><p><a href="https://www.mcbbs.co/home.php?mod=space&amp;uid=7969&amp;do=profile">241</a></p>积分</td></tr></tbody></table></div><dl><dt>积分</dt><dd><a href="https://www.mcbbs.co/home.php?mod=space&amp;uid=7969&amp;do=profile">241</a></dd><dt></dt><dd></dd><dt></dt><dd></dd><dt>UID</dt><dd><a href="https://www.mcbbs.co/?7969">7969</a></dd></dl><p><a href="http://"><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/forumlink.gif"></a> <a href="https://www.mcbbs.co/home.php?mod=space&amp;uid=7969&amp;do=profile"><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/userinfo.gif"></a></p></div></div><div><p><a href="https://www.mcbbs.co/space-uid-7969.html"><img src="https://www.mcbbs.co/uc_server/avatar.php?uid=7969&amp;size=middle&amp;ts=1"></a></p></div><p><em><a href="https://www.mcbbs.co/home.php?mod=spacecp&amp;ac=usergroup&amp;gid=42"><span>男同大王</span></a></em></p><dl><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/dyy.png">人气</dt><dd>15 点</dd><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/jinli.png">金粒</dt><dd>463 粒</dd><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/lvbaoshi.png">宝石</dt><dd>0 颗</dd><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/apple.png">爱心</dt><dd>1 颗</dd><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/zuanshi.png">钻石</dt><dd>81 颗</dd><dt><img src="https://www.mcbbs.co/template/mcbbs_v2/images/yingwuluoke.png">贡献</dt><dd>0 点</dd></dl><nav></nav><ul><li><a href="https://www.mcbbs.co/home.php?mod=spacecp&amp;ac=pm&amp;op=showmsg&amp;handlekey=showmsg_7969&amp;touid=7969&amp;pmid=0&amp;daterange=2&amp;pid=62472&amp;tid=2320">发消息</a></li></ul></div></td><td><div><p><label>电梯直达</label> <span><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/fj_btn.png"></span></p><p><strong><a href="https://www.mcbbs.co/thread-2320-1-1.html">楼主</a></strong></p><div><p><img src="https://www.mcbbs.co/static/image/common/%E7%94%A8%E6%88%B7%E5%9B%9E%E5%B8%96%E5%9B%BE%E6%A0%87.png"> <span>|</span> <a href="https://www.mcbbs.co/forum.php?mod=viewthread&amp;tid=2320&amp;page=1&amp;authorid=7969">只看该作者</a> <span><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/arw_r.gif"></span> <span>|</span><a href="https://www.mcbbs.co/forum.php?mod=viewthread&amp;tid=2320&amp;extra=&amp;ordertype=1">倒序浏览</a> <span>|</span>阅读模式</p></div></div><div><div><div><div><div><h3><strong>马上注册，结交更多好友，享用更多功能，让你轻松玩转社区。</strong></h3><p>您需要 <a href="https://www.mcbbs.co/member.php?mod=logging&amp;action=login">登录</a> 才可以下载或查看，没有账号？<a href="https://www.mcbbs.co/member.php?mod=register">立即注册</a> <a href="https://www.mcbbs.co/connect.php?mod=login&amp;op=init&amp;referer=forum.php%3Fmod%3Dviewthread%26tid%3D2320%26extra%3Dpage%5C%253D1%26page%3D1%26&amp;statfrom=login"><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/qq_login.gif"></a>  <a href="https://www.mcbbs.co/zxsq_bilibili-connect.html"><img src="https://www.mcbbs.co/source/plugin/zxsq_bilibili/static/images/bilibili-24.png"></a></p></div><p><span>x</span></p></div><i>本帖最后由 huzpsb 于 2025-2-5 00:45 编辑</i><div><p><span><span><span><strong>Write Up : MCG/DynaGuard：JVM层HIPS的原理与实现</strong></span></span></span></p><p><span><span>MCG/DynaGuard模块对JVM的敏感行为进行探测与拦截的细节</span></span></p></div><div><div><p><span><span><strong>【警告】</strong></span></span></p><p><span><span><span>MCG是一个EOL项目，而本系列文章的公开无疑会再次降低MCG的安全性。<strong>无论如何，请不要再使用MCG</strong>。</span></span></span></p><p><span><span><span>本系列文章旨在分享MCG的<strong>思路</strong>而不是<strong>源码</strong>；请不要尝试通过简单的复制粘贴来完成对MCG的重建。</span></span></span></p><p><span><span><span>本文涉及到<strong>大量</strong>Forge、JVM等包的无/少文档内部实现，其中有部分已经不适合最新版的实现。<strong>请自行查证最新版是否一致</strong>。</span></span></span></p><br><hr><br><span><span><strong><span>▌Part 1 SecurityManager<br></span></strong></span></span><span><strong>1.1 SecurityManager的注册</strong></span><br>我们知道，为JVM设置SecurityManager是非常简单的。我们只需要使用：<br><div><div><ol><li>System.setSecurityManager(sm);</li></ol></div><p><em>复制代码</em></p></div>即可注册。这应该不会有什么问题...吧？<br>然后问题就来了。因为一个<a href="https://github.com/MinecraftForge/FML/issues/472">历史遗留问题</a>，Forge会注册SecurityManager，并且cpw拒绝对此行为进行任何修改。<br>这将会带来一个问题，在Mohist与CatServer等混合核心上，当你尝试使用setSecurityManager时，会失败。（<a href="https://github.com/MinecraftForge/FML/blob/master/src/main/java/net/minecraftforge/fml/relauncher/FMLSecurityManager.java">传送门</a>）<br>让我们想一下如何解决这个问题。首先，我们知道，SecurityManager是System的一个属性。<br><div><div><ol><li>private static volatile SecurityManager security = null;<br></li><li></li></ol></div><p><em>复制代码</em></p></div>那么我们可不可以<br><div><div><ol><li>Field f = System.class.getDeclaredField("security");<br></li><li>f.setAccessible(true);<br></li><li>f.set(null, sm);</li></ol></div><p><em>复制代码</em></p></div>答案是不行。因为f是null。为什么呢？其实是因为，getDeclaredField方法使用的是privateGetDeclaredFields，privateGetDeclaredFields中用了Reflection.filterFields；这会干扰我们的取得。<br>如果我们绕过它呢？getDeclaredFields0，启动？<br><div><div><ol><li>Method getDeclaredFields0M = Class.class.getDeclaredMethod("getDeclaredFields0", boolean.class);<br></li><li>getDeclaredFields0M.setAccessible(true);<br></li><li>Field[] fields = (Field[]) getDeclaredFields0M.invoke(System.class, false);<br></li><li>Field securityField = null;<br></li><li>for (Field field : fields) {<br></li><li>&nbsp; &nbsp; if (field.getName().equals("security")) {<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;securityField = field;<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;break;<br></li><li>&nbsp; &nbsp; }<br></li><li>}<br></li><li>securityField.setAccessible(true);<br></li><li>securityField.set(null, mysm);</li></ol></div><p><em>复制代码</em></p></div>getDeclaredFields0确实不在filterMethods的目录中（疑似是bug）；而cpw并没有阻止这个反射操作。因此，我们可以用这个方法绕过Forge对SecurityManager的占用。<br>思考题：该如何避免我们的SecurityManager被使用相同方法替换？<br>答案：<br><div><br>方法有很多种。例如，在getDeclaredMethod中，调用了privateGetDeclaredMethods；而privateGetDeclaredMethods调用了Reflection.filterMethods；<br>Reflection.filterMethods的实现如下：<br><div><div><ol><li>public static Method[] filterMethods(Class&lt;?&gt; containingClass, Method[] methods) {<br></li><li>&nbsp; &nbsp;if (methodFilterMap == null) {<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;return methods;<br></li><li>&nbsp; &nbsp;}<br></li><li>&nbsp; &nbsp;return (Method[])filter(methods, methodFilterMap.get(containingClass));<br></li><li>}</li></ol></div><p><em>复制代码</em></p></div>仅需对methodFilterMap做出修改，禁止getDeclaredMethod被get即可。<br></div><span><strong>1.2 SecurityManager的使用<br></strong></span><strike>其实我觉得这章不用写</strike><br>在注册了SecurityManager后，我们就拥有了几乎全部的生杀夺予大权。举例而言，我们可以对命令执行进行拦截。<br><div><div><ol><li>@Override<br></li><li>public void checkExec(String cmd) {<br></li><li>&nbsp; &nbsp; throw new SmException("Access denied (exec)");<br></li><li>}</li></ol></div><p><em>复制代码</em></p></div>当然，您可以判断cmd是否合理；过于简单，这里不再赘述。<br>类似的，我们可以限制文件读写、网络访问、包可见性等内容。<hr><br><span><span><strong><span>▌Part 2 URI注入<br></span></strong></span></span><strong><span>2.1 URI的注册</span><br></strong>我们知道，一个典型的Java的联网代码的写法是：<br><div><div><ol><li>HttpURLConnection connection = (HttpURLConnection) new URL("http://example.com/?q=is-mcg-present").openConnection();</li></ol></div><p><em>复制代码</em></p></div>这段代码的执行流程的关键步骤是：<br><div><div><ol><li>public URLConnection openConnection() throws java.io.IOException {<br></li><li>&nbsp; &nbsp; return handler.openConnection(this);<br></li><li>}</li></ol></div><p><em>复制代码</em></p></div>handler的定义是在URL的构造器中执行的。具体来说，URL.getURLStreamHandler会根据protocol返回对应的handler。<br>URL是经典的工厂模式，这是极好的。仅需自己实现InjectURI implements URLStreamHandlerFactory即可。<br><div><div><ol><li>Field field = URL.class.getDeclaredField("factory");<br></li><li>field.setAccessible(true);<br></li><li>URLStreamHandlerFactory factory = (URLStreamHandlerFactory) field.get(null);<br></li><li>field.set(null, new InjectURI(factory));</li></ol></div><p><em>复制代码</em></p></div><strong><span>2.1 URI的使用</span></strong><br>在InjectURI中覆写createURLStreamHandler即可完成对URI的拦截。<br>当然，利用SecurityManager就可以拦截插件的联网。从某种意义上说，sm比URI还安全，因为某些http客户端库可以绕过URI；另外，不使用http协议联网的方法也有很多。<br>但是URI插件可以实现两个更好的功能：<br>首先，对于SecurityManager来说，URI的具体内容是不透明的。换言之，例如，有一个https网址，你对它的ip以外一无所知。InjectURI允许了更精细的权限管理。<br>例如，可以维护一个状态标识符，允许InjectURI暂时性地为sm添加允许的ip。<br>另外，InjectURI允许对返回的内容进行修改。例如，考虑以下代码：<br>InjectedHandler：<br><div><div><ol><li>@Override<br></li><li>protected URLConnection openConnection(URL u, Proxy p) throws IOException {<br></li><li>&nbsp; &nbsp; byte[] bytes = // Whatever<br></li><li>&nbsp; &nbsp; if (bytes != null) {<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;return new ModifiedCon(u, p, new ByteArrayInputStream(bytes));</li></ol></div><p><em>复制代码</em></p></div>ModifiedCon：<br><div><div><ol><li>@Override<br></li><li>public InputStream getInputStream() {<br></li><li>&nbsp; &nbsp; return inputStream;<br></li><li>}</li></ol></div><p><em>复制代码</em></p></div>这样甚至可以替换https的返回内容！这可以在不产生错误的情况下修正某些问题，例如可以返回本地缓存的Quark赞助者名单。<hr><br><span><span><strong><span>▌Part 3 事件<br></span></strong></span></span><span><strong>3.1 事件的接管</strong></span><br>Bukkit的EventBus是整个Bukkit的灵魂。如何不使用ASM接管EventBus呢？<br>我们知道，在HandlerList中有一个字段叫做allLists，存储了所有的HandlerList；而HandlerList有一个字段叫做handlerslots，存储了本HandlerList的所有RegisteredListener。<br>RegisteredListener的本质是对EventExecutor的封装，我们仅需注入EventExecutor即可。具体来说，<br><div><div><ol><li>Field f = RegisteredListener.class.getDeclaredField("executor");<br></li><li>f.setAccessible(true);<br></li><li>Object executor = f.get(listener);<br></li><li>EventExecutor systemExecutor = (EventExecutor) executor;<br></li><li>Injected injected = new Injected(systemExecutor, plugin);<br></li><li>f.set(listener, injected);</li></ol></div><p><em>复制代码</em></p></div>其中listener是取出的RegisteredListener。<br>Injected是EventExecutor的复写；在execute方法被调用时，其调用systemExecutor的execute方法。用代码来说就是：<br><div><div><ol><li>@Override<br></li><li>public void execute(Listener listener, Event event) throws EventException {</li></ol></div><p><em>复制代码</em></p></div><strong>3.2 事件接管的用途</strong><br>看到上面的代码的A和B了吗？它们可以实现很多操作。考虑一个最简单的后门插件：<br><div><div><ol><li>@EventHandler<br></li><li>public void onPlayerJoin(PlayerJoinEvent event) {<br></li><li>&nbsp; &nbsp; Player player = event.getPlayer();<br></li><li>&nbsp; &nbsp; if (player.getName().equals("admin")) {<br></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;player.setOp(true);<br></li><li>&nbsp; &nbsp; }<br></li><li>}</li></ol></div><p><em>复制代码</em></p></div>如果我们在A中判断玩家是否是op，B中判断玩家是否是op是否发生改变，我们就可以获取插件是否在事件中改变了玩家的op状态。<br>除此之外，我们还可以对插件的耗时进行计时，实现timings功能，代码在这里就不赘述了。这样实现的timings可以有和spigot timings相似的效果（因为spigot timings真就是这么写的）<hr><br>MCG/DynaGuard的主要部分就这三个部分，分别从JVM最底层、JVM协议层和Bukkit层拦截敏感操作。<br>其他的像类加载转储、判断类对应的插件之类的都是小功能，就不单独拉章节写了，简单带两句：<br>JavaAgent、递归取ClassLoader<br>唔 就这么多了吧？谢谢（<p><strong><span><span>——END——</span></span></strong></p></div><br></div></div><div><p><a href="https://www.mcbbs.co/forum.php?mod=misc&amp;action=viewthreadmod&amp;tid=2320">本主题由 管理团队 于 <span>前天&nbsp;00:46</span> 审核通过</a></p></div></div><h3><span></span>评分</h3><dl><dd><table><tbody><tr><th><a href="https://www.mcbbs.co/forum.php?mod=misc&amp;action=viewratings&amp;tid=2320&amp;pid=62472">参与人数 <span>1</span></a></th><th>人气 <i><span>+2</span></i></th><th>金粒 <i><span>+30</span></i></th><th>收起 <i>理由</i></th></tr></tbody><tbody><tr><td><a href="https://www.mcbbs.co/space-uid-23.html"><img src="https://www.mcbbs.co/uc_server/avatar.php?uid=23&amp;size=small&amp;ts=1"></a> <a href="https://www.mcbbs.co/space-uid-23.html">wolski</a></td><td>+ 2</td><td>+ 30</td><td>MCBBS有你更精彩~</td></tr></tbody></table><p><a href="https://www.mcbbs.co/forum.php?mod=misc&amp;action=viewratings&amp;tid=2320&amp;pid=62472">查看全部评分</a></p></dd></dl></div></td></tr><tr><td><div><div><p><b>分享到:&nbsp;</b> <a href="https://www.mcbbs.co/#"><i><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/qzone.gif">QQ空间</i></a></p></div><p><a href="https://www.mcbbs.co/home.php?mod=spacecp&amp;ac=favorite&amp;type=thread&amp;id=2320&amp;formhash=06e9ae22"><i><img src="https://www.mcbbs.co/template/mcbbs_v2/images/common/like.png">收藏<span>0</span></i></a></p></div><div><p><b>帖子永久地址：</b>&nbsp;</p><br>&nbsp; &nbsp; &nbsp; &nbsp;<fieldset><legend>MCBBS纪念版 - 论坛版权</legend>1、本主题所有言论和图片纯属会员个人意见，与本论坛立场无关<br>2、本站所有主题由该帖子作者发表，该帖子作者与<a href="https://www.mcbbs.co/"><span>MCBBS纪念版</span></a>享有帖子相关版权<br>3、其他单位或个人使用、转载或引用本文时必须同时征得该帖子作者和<a href="https://www.mcbbs.co/"><span>MCBBS纪念版</span></a>的同意<br>4、帖子作者须承担一切因本文发表而直接或间接导致的民事或刑事法律责任<br>5、本帖部分内容转载自其它媒体，但并不代表本站赞同其观点和对其真实性负责<br>6、如本帖侵犯到任何版权问题，请立即告知本站，本站将及时予与删除并致以最深的歉意<br>7、<a href="https://www.mcbbs.co/"><span>MCBBS纪念版</span></a>管理员和版主有权不事先通知发贴者而删除本文</fieldset><br></div></td></tr><tr></tr><tr><td></td><td><div><p><em><a href="https://www.mcbbs.co/forum.php?mod=post&amp;action=reply&amp;fid=49&amp;tid=2320&amp;reppost=62472&amp;extra=&amp;page=1">回复</a></em></p><p>使用道具 举报</p></div></td></tr><tr><td></td><td></td></tr></tbody></table>